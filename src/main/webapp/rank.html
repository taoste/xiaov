<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link href="http://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" rel="stylesheet">
	<link href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
	<link href="index.css" rel="stylesheet">
	<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
	<script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdn.bootcss.com/clipboard.js/1.7.1/clipboard.js"></script>
</head>
<body>
<script type="text/javascript">


</script>




<div id="h">
  <select id="server" class="form-control" style="width: 300px">
    <option value="0">请选择服务器</option>
    <option value="8">8</option>
    <option value="16">16</option>
    <option value="19">19</option>
  </select>
  <button type="button" class="btn btn-primary" onclick="search();">查询</button>
</div>
<div id="main">

</div>
<script type="text/javascript">
  var u;
  function search(){
    var server = $('#server').val();
    if(server==0){
      return;
    }else{
      var url = '/api/calrank?server='+server;
      $.get(url,function(response,status){
        var data = eval("("+response+")");
        u=data;
        generateTable()
      })
    }
  }

  function sortby(type){
    u.d.sort(function(a,b){
      if(type==0){
        return b.senka-a.senka;
      }else if(type==1){
        return b.subsenka-a.subsenka;
      }else if(type==2){
        return a.ex-b.ex;
      }else if(type==3){
        return b.max-a.max;
      }else if(type==4){
        return b.min-a.min;
      }
    });
    generateTable();
  }

  function generateTable(){
    var data = u;
    var result = data.r;
    var zexfrom = data.exfrom;
    var zexto = data.exto;
    var zexpfrom = data.expfrom;
    var zexpto = data.expto;
    var minmap = data.min;
    var now = new Date();
    var month = now.getMonth();
    if(result==0) {
      var h = '统计时间：' + new Date(data.ts).toLocaleString();
      h = h + '<table class="table table-bordered table-striped table-hover">';
      h = h + '<thead><td>排名(当前/榜单)</td><td></td><td><div onclick="sortby(0);">当前</div></td>';
      h = h + '<td><div onclick="sortby(1);"> 经验  (' + new Date(zexpfrom).toLocaleString() + '----' + new Date(zexpto).toLocaleString() + ')</div></td>';
      h = h + '<td><div onclick="sortby(2);">ex  (' + new Date(zexfrom).toLocaleString() + '----' + new Date(zexto).toLocaleString() + ')</div></td>';
      h = h + '<td><div onclick="sortby(3);">最大</div></td><td><div onclick="sortby(4);">最小</div></td></thead>';
      for (var i = 0; i < data.d.length; i++) {
        var type = data.d[i].type;
        var senka = data.d[i];
        var z = data.d[i].z;
        var zcleared=0;
        if(Math.floor(((month+1)/3)%4)==Math.floor(((z+1)/3))%4){
          if(z>=0){
            h=h+'（'+(z+1)+'月已完成Z作战）';
            zcleared=350;
          }
        }

        if (i == 5 || i == 20 || i == 100 || i == 500) {
          h = h + '<td> </td></tr><tr>';
        }
        h = h + '<tr>';
        h = h + '<td>' + (i + 1) + '位(' + senka.lno + '位)</td>';
        h = h + '<td>' + senka.name + '</td>';
        h = h + '<td>' + senka.senka + '</td>';
        var subsenkastr = senka.subsenka;
        var expfrom = senka.expfrom;
        var expto = senka.expto;
        if (Math.abs(expfrom - zexpfrom) > 1200000 || Math.abs(expto - zexpto) > 1200000) {
          subsenkastr = subsenkastr + '    (' + new Date(expfrom).toLocaleString() + '----' + new Date(expto).toLocaleString() + ')';
        }
        h = h + '<td>' + subsenkastr + '</td>';
        if (type == 1) {
          var exfrom = senka.exfrom;
          var exto = senka.exto;
          var ensure = 0;
          if (Math.abs(exfrom - zexfrom) < 1200000 && Math.abs(exto - zexto) < 1200000) {
            h = h + '<td>' + senka.ex + '';
            ensure = 1;
          } else {
            h = h + '<td>' + senka.ex + '    (' + new Date(exfrom).toLocaleString() + '----' + new Date(exto).toLocaleString() + ')';
          }

          h=h+'</td>';
          if (ensure) {
            h = h + '<td colspan="2">' + (senka.senka + 1380 - zcleared - senka.ex) + '</td>';
            data.d[i].except=senka.senka + 1380 - zcleared - senka.ex;
            data.d[i].max=data.d[i].except;
            data.d[i].min=data.d[i].except;
          } else {
            if (senka.fsenkats == 0 && getDateNo(senka.expfrom) == 0) {
              h = h + '<td colspan="2">' + (senka.subsenka + senka.fsenka + 1380 - zcleared) + '</td>';
              data.d[i].except=senka.subsenka + senka.fsenka + 1380 - zcleared;
              data.d[i].max=data.d[i].except;
              data.d[i].min=data.d[i].except;
            } else {
              var firstExpDateNo = getDateNo(expfrom);
              var maxsenka1 = senka.subsenka+minmap[firstExpDateNo]+1380-zcleared;
              var minsenka = senka.subsenka+1380-zcleared;
              var maxsenka2 = senka.senka + 1380 - senka.ex-zcleared;
              var maxsenka3 = senka.subsenka + senka.fsenka + 1380-zcleared;
              var maxsenka = Math.min(maxsenka1,maxsenka2,maxsenka3);
              h = h + '<td>' + maxsenka + '</td>';
              h = h + '<td>' + minsenka + '</td>';
              data.d[i].max=maxsenka;
              data.d[i].min=minsenka;
            }
          }
        } else if (type == 3) {
          h = h + '<td>' + 'unknown' + '</td>';
          console.log(senka);
          var firstExpDateNo = getDateNo(expfrom);
          var maxsenka1 = senka.subsenka+minmap[firstExpDateNo]+1380-zcleared;
          var minsenka = senka.subsenka+1380-zcleared;
          var maxsenka2 = senka.senka + 1380 - senka.ex-zcleared;
          var maxsenka3 = senka.subsenka + senka.fsenka + 1380-zcleared;
          var maxsenka = Math.min(maxsenka1,maxsenka2,maxsenka3);
          h = h + '<td>' + maxsenka + '</td>';
          h = h + '<td>' + minsenka + '</td>';
          data.d[i].max=maxsenka;
          data.d[i].min=minsenka;
        } else if (type == 2) {
          var exfrom = senka.exfrom;
          var exto = senka.exto;
          if (Math.abs(exfrom - zexfrom) < 600000 && Math.abs(exto - zexto) < 600000) {
            h = h + '<td>' + senka.ex + '</td>';
          } else {
            h = h + '<td>' + senka.ex + '(' + new Date(exfrom).toLocaleString() + '----' + new Date(exto).toLocaleString() + ')</td>';
          }
          h = h + '<td>' + (senka.senka + 1380 - senka.ex) + '</td>';
        }
        h = h + '</tr>';
      }
      h = h + '</table>'
      $('#main').html(h);
      console.log(data);
    }
  }


  getDateNo = function(now){
    now = new Date(new Date(now).getTime()+(new Date().getTimezoneOffset()+480)*60000)
    var date = now.getDate()
    var hour = now.getHours()
    if(hour<1){
      date = date -1
      hour = hour + 24
    }
    const no = (date-1)*2+((hour>=13)?1:0)
    return no
  }

  getRankDateNo = function(now){
    now = new Date(new Date(now).getTime()+(new Date().getTimezoneOffset()+480)*60000)
    var date = now.getDate()
    var hour = now.getHours()
    if(hour<2){
      date = date -1
      hour = hour + 24
    }
    const no = (date-1)*2+((hour>=14)?1:0)
    return no
  }








</script>

</body>
</html>